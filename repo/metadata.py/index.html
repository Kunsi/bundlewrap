<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>bundles/.../metadata.py - BundleWrap</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../bundlewrap.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-33891245-2', 'docs.bundlewrap.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BundleWrap</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link"><i class="fa fa-home"></i></a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../guide/quickstart/" class="dropdown-item">Quickstart</a>
</li>
                                    
<li>
    <a href="../../guide/installation/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../../guide/cli/" class="dropdown-item">CLI</a>
</li>
                                    
<li>
    <a href="../../guide/env/" class="dropdown-item">Environment Variables</a>
</li>
                                    
<li>
    <a href="../../guide/item_file_templates/" class="dropdown-item">File templates</a>
</li>
                                    
<li>
    <a href="../../guide/secrets/" class="dropdown-item">Handling secrets</a>
</li>
                                    
<li>
    <a href="../../guide/locks/" class="dropdown-item">Locking</a>
</li>
                                    
<li>
    <a href="../../guide/kubernetes/" class="dropdown-item">Kubernetes</a>
</li>
                                    
<li>
    <a href="../../guide/dev_item/" class="dropdown-item">Custom items</a>
</li>
                                    
<li>
    <a href="../../guide/dev_plugin/" class="dropdown-item">Writing plugins</a>
</li>
                                    
<li>
    <a href="../../guide/api/" class="dropdown-item">Python API</a>
</li>
                                    
<li>
    <a href="../../guide/os_compatibility/" class="dropdown-item">OS compatibility</a>
</li>
                                    
<li>
    <a href="../../guide/migrate_12/" class="dropdown-item">Migrating to 2.0</a>
</li>
                                    
<li>
    <a href="../../guide/migrate_23/" class="dropdown-item">Migrating to 3.0</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Repository <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../layout/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../nodes.py/" class="dropdown-item">nodes.py</a>
</li>
                                    
<li>
    <a href="../groups.py/" class="dropdown-item">groups.py</a>
</li>
                                    
<li>
    <a href="../requirements.txt/" class="dropdown-item">requirements.txt</a>
</li>
                                    
<li>
    <a href="../items.py/" class="dropdown-item">bundles/.../items.py</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">bundles/.../metadata.py</a>
</li>
                                    
<li>
    <a href="../hooks/" class="dropdown-item">hooks/</a>
</li>
                                    
<li>
    <a href="../libs/" class="dropdown-item">libs/</a>
</li>
                                    
<li>
    <a href="../plugins/" class="dropdown-item">Plugins</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Items <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../items/action/" class="dropdown-item">action</a>
</li>
                                    
<li>
    <a href="../../items/directory/" class="dropdown-item">directory</a>
</li>
                                    
<li>
    <a href="../../items/file/" class="dropdown-item">file</a>
</li>
                                    
<li>
    <a href="../../items/group/" class="dropdown-item">group</a>
</li>
                                    
<li>
    <a href="../../items/k8s/" class="dropdown-item">k8s_*</a>
</li>
                                    
<li>
    <a href="../../items/pkg_apt/" class="dropdown-item">pkg_apt</a>
</li>
                                    
<li>
    <a href="../../items/pkg_dnf/" class="dropdown-item">pkg_dnf</a>
</li>
                                    
<li>
    <a href="../../items/pkg_openbsd/" class="dropdown-item">pkg_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/pkg_opkg/" class="dropdown-item">pkg_opkg</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pacman/" class="dropdown-item">pkg_pacman</a>
</li>
                                    
<li>
    <a href="../../items/pkg_pip/" class="dropdown-item">pkg_pip</a>
</li>
                                    
<li>
    <a href="../../items/pkg_snap/" class="dropdown-item">pkg_snap</a>
</li>
                                    
<li>
    <a href="../../items/pkg_yum/" class="dropdown-item">pkg_yum</a>
</li>
                                    
<li>
    <a href="../../items/pkg_zypper/" class="dropdown-item">pkg_zypper</a>
</li>
                                    
<li>
    <a href="../../items/postgres_db/" class="dropdown-item">postgres_db</a>
</li>
                                    
<li>
    <a href="../../items/postgres_role/" class="dropdown-item">postgres_role</a>
</li>
                                    
<li>
    <a href="../../items/svc_openbsd/" class="dropdown-item">svc_openbsd</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemd/" class="dropdown-item">svc_systemd</a>
</li>
                                    
<li>
    <a href="../../items/svc_systemv/" class="dropdown-item">svc_systemv</a>
</li>
                                    
<li>
    <a href="../../items/svc_upstart/" class="dropdown-item">svc_upstart</a>
</li>
                                    
<li>
    <a href="../../items/symlink/" class="dropdown-item">symlink</a>
</li>
                                    
<li>
    <a href="../../items/user/" class="dropdown-item">user</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../misc/about/" class="dropdown-item">About</a>
</li>
                                    
<li>
    <a href="../../misc/deciding/" class="dropdown-item">Why BundleWrap</a>
</li>
                                    
<li>
    <a href="../../misc/glossary/" class="dropdown-item">Glossary</a>
</li>
                                    
<li>
    <a href="../../misc/faq/" class="dropdown-item">FAQ</a>
</li>
                                    
<li>
    <a href="../../misc/contributing/" class="dropdown-item">Contributing</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../items.py/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../hooks/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/bundlewrap/bundlewrap/edit/master/docs/repo/metadata.py.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#metadatapy" class="nav-link">metadata.py</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#available-options" class="nav-link">Available options</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="metadatapy">metadata.py</h1>
<p>Alongside <code>items.py</code> you may create another file called <code>metadata.py</code>. It can be used to do advanced processing of the metadata you configured for your nodes and groups. Specifically, it allows each bundle to modify metadata before <code>items.py</code> is evaluated.</p>
<p>This is accomplished through metadata processors. Metadata processors are functions that take the metadata dictionary generated so far as their single argument. You must then return a dictionary with any modifications you need to make plus at least one of several options:</p>
<pre><code>@metadata_processor
def my_metadata_processor(metadata):
    metadata["foo"] = node.name
    return metadata, DONE
</code></pre>
<p>You must always return the modified metadata dictionary as the first element. After that, there are a few options you can return. Every metadata processor from every bundle is called <em>repeatedly</em> with the latest metadata dictionary until it indicates that it is done by returning the <code>DONE</code> option or until <em>all</em> remaining metadata processors return <code>RUN_ME_AGAIN</code>. You must always return one of <code>DONE</code> or <code>RUN_ME_AGAIN</code>. Use the latter if your metadata processor depends on metadata that is generated by another metadata processor (which may be called after yours). Here is another example:</p>
<pre><code>@metadata_processor
def first_metadata_processor(metadata):
    metadata["foo"] = node.name
    return metadata, DONE

@metadata_processor
def second_metadata_processor(metadata):
    if "foo" in metadata:
        metadata["bar"] = metadata["foo"]
        return metadata, DONE
    else:
        return metadata, RUN_ME_AGAIN
</code></pre>
<p>In this example, <code>"bar"</code> can only be set once <code>"foo"</code> is available and thus the <code>second_metadata_processor</code> has to wait and request to <code>RUN_ME_AGAIN</code> until <code>first_metadata_processor</code> ran. This is necessary because the running order of metadata processors is undefined.</p>
<div class="alert alert-danger">To avoid deadlocks when accessing <strong>other</strong> nodes' metadata from within a metadata processor, use <code>other_node.partial_metadata</code> instead of <code>other_node.metadata</code>. For the same reason, always use the <code>metadata</code> parameter to access the current node's metadata, never <code>node.metadata</code>.</div>

<p><br></p>
<h2 id="available-options">Available options</h2>
<table>
<tr><th>Option</th><th>Description</th></tr>
<tr><td><code>DONE</code></td><td>Indicates that this metadata processor has done all it can and need not be called again. Return this whenever possible.</td></tr>
<tr><td><code>RUN_ME_AGAIN</code></td><td>Indicates that this metadata processor is still waiting for metadata from another metadata processor to become available.</td></tr>
<tr><td><code>DEFAULTS</code></td><td>The returned metadata dictionary will only be used to provide default values. The actual metadata generated so far will be recursively merged into the returned dict. When using this flag, you must not return the original metadata dictionary but construct a new one as in the example below.</td></tr>
<tr><td><code>OVERWRITE</code></td><td>The returned metadata dictionary will be recursively merged into the actual metadata generated so far (inverse of <code>DEFAULTS</code>). When using this flag, you must not return the original metadata dictionary but construct a new one as in the `DEFAULTS` example below.</td></tr>
</table>

<p>Here is an example of how to use <code>DEFAULTS</code>:</p>
<pre><code>@metadata_processor
def my_metadata_processor(metadata):
    return {
        "foo": {
            "bar": 47,
        },
    }, DONE, DEFAULTS
</code></pre>
<p>This means <code>node.metadata["foo"]["bar"]</code> will be 47 by default, but can also be overridden in static metadata at the node/group level.</p>
<p><br></p>
<div class="alert alert-info">For your convenience, you can access <code>repo</code>, <code>node</code>, <code>metadata_processor</code> and all the options in <code>metadata.py</code> without importing them.</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>BundleWrap is published under the <a href='https://github.com/bundlewrap/bundlewrap/blob/master/LICENSE'>GPL license</a>.</p><p> Donations welcome in Bitcoin <code>13AJYksqncZromPF8HvDUXsmHChAm3Y7W7</code> or Ethereum <code>0x5Eb3037e197d3C0d2E014bcfC2e027EB0AD42812</code>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
