<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Custom items - BundleWrap</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../bundlewrap.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-33891245-2', 'docs.bundlewrap.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">BundleWrap</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../.."><i class="fa fa-home"></i></a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../quickstart/">Quickstart</a>
</li>
                                    
<li >
    <a href="../installation/">Installation</a>
</li>
                                    
<li >
    <a href="../cli/">CLI</a>
</li>
                                    
<li >
    <a href="../env/">Environment Variables</a>
</li>
                                    
<li >
    <a href="../item_file_templates/">File templates</a>
</li>
                                    
<li >
    <a href="../secrets/">Handling secrets</a>
</li>
                                    
<li >
    <a href="../locks/">Locking</a>
</li>
                                    
<li >
    <a href="../kubernetes/">Kubernetes</a>
</li>
                                    
<li class="active">
    <a href="./">Custom items</a>
</li>
                                    
<li >
    <a href="../dev_plugin/">Writing plugins</a>
</li>
                                    
<li >
    <a href="../api/">Python API</a>
</li>
                                    
<li >
    <a href="../os_compatibility/">OS compatibility</a>
</li>
                                    
<li >
    <a href="../migrate_12/">Migrating to 2.0</a>
</li>
                                    
<li >
    <a href="../migrate_23/">Migrating to 3.0</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Repository <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../repo/layout/">Overview</a>
</li>
                                    
<li >
    <a href="../../repo/nodes.py/">nodes.py</a>
</li>
                                    
<li >
    <a href="../../repo/groups.py/">groups.py</a>
</li>
                                    
<li >
    <a href="../../repo/requirements.txt/">requirements.txt</a>
</li>
                                    
<li >
    <a href="../../repo/items.py/">bundles/.../items.py</a>
</li>
                                    
<li >
    <a href="../../repo/metadata.py/">bundles/.../metadata.py</a>
</li>
                                    
<li >
    <a href="../../repo/hooks/">hooks/</a>
</li>
                                    
<li >
    <a href="../../repo/libs/">libs/</a>
</li>
                                    
<li >
    <a href="../../repo/plugins/">Plugins</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Items <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../items/action/">action</a>
</li>
                                    
<li >
    <a href="../../items/directory/">directory</a>
</li>
                                    
<li >
    <a href="../../items/file/">file</a>
</li>
                                    
<li >
    <a href="../../items/group/">group</a>
</li>
                                    
<li >
    <a href="../../items/k8s/">k8s_*</a>
</li>
                                    
<li >
    <a href="../../items/pkg_apt/">pkg_apt</a>
</li>
                                    
<li >
    <a href="../../items/pkg_dnf/">pkg_dnf</a>
</li>
                                    
<li >
    <a href="../../items/pkg_openbsd/">pkg_openbsd</a>
</li>
                                    
<li >
    <a href="../../items/pkg_opkg/">pkg_opkg</a>
</li>
                                    
<li >
    <a href="../../items/pkg_pacman/">pkg_pacman</a>
</li>
                                    
<li >
    <a href="../../items/pkg_pip/">pkg_pip</a>
</li>
                                    
<li >
    <a href="../../items/pkg_snap/">pkg_snap</a>
</li>
                                    
<li >
    <a href="../../items/pkg_yum/">pkg_yum</a>
</li>
                                    
<li >
    <a href="../../items/pkg_zypper/">pkg_zypper</a>
</li>
                                    
<li >
    <a href="../../items/postgres_db/">postgres_db</a>
</li>
                                    
<li >
    <a href="../../items/postgres_role/">postgres_role</a>
</li>
                                    
<li >
    <a href="../../items/svc_openbsd/">svc_openbsd</a>
</li>
                                    
<li >
    <a href="../../items/svc_systemd/">svc_systemd</a>
</li>
                                    
<li >
    <a href="../../items/svc_systemv/">svc_systemv</a>
</li>
                                    
<li >
    <a href="../../items/svc_upstart/">svc_upstart</a>
</li>
                                    
<li >
    <a href="../../items/symlink/">symlink</a>
</li>
                                    
<li >
    <a href="../../items/user/">user</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/about/">About</a>
</li>
                                    
<li >
    <a href="../../misc/deciding/">Why BundleWrap</a>
</li>
                                    
<li >
    <a href="../../misc/glossary/">Glossary</a>
</li>
                                    
<li >
    <a href="../../misc/faq/">FAQ</a>
</li>
                                    
<li >
    <a href="../../misc/contributing/">Contributing</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../kubernetes/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../dev_plugin/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/bundlewrap/bundlewrap/edit/master/docs/guide/dev_item.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#custom-item-types">Custom item types</a></li>
            <li><a href="#step-0-understand-statedicts">Step 0: Understand statedicts</a></li>
            <li><a href="#step-1-create-an-item-module">Step 1: Create an item module</a></li>
            <li><a href="#step-2-define-attributes">Step 2: Define attributes</a></li>
            <li><a href="#step-3-implement-methods">Step 3: Implement methods</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="custom-item-types">Custom item types</h1>
<h2 id="step-0-understand-statedicts">Step 0: Understand statedicts</h2>
<p>To represent supposed vs. actual state, BundleWrap uses statedicts. These are
normal Python dictionaries with some restrictions:</p>
<ul>
<li>keys must be Unicode text</li>
<li>every value must be of one of these simple data types:<ul>
<li>bool</li>
<li>float</li>
<li>int</li>
<li>Unicode text</li>
<li>None</li>
</ul>
</li>
<li>...or a list/tuple containing only instances of one of the types above</li>
</ul>
<p>Additional information can be stored in statedicts by using keys that start with an underscore. You may only use this for caching purposes (e.g. storing rendered file template content while the "real" sdict information only contains a hash of this content). BundleWrap will ignore these keys and hide them from the user. The type restrictions noted above do not apply.</p>
<h2 id="step-1-create-an-item-module">Step 1: Create an item module</h2>
<p>Create a new file called <code>/your/bundlewrap/repo/items/foo.py</code>. You can use this as a template:</p>
<pre><code>from bundlewrap.items import Item


class Foo(Item):
    """
    A foo.
    """
    BUNDLE_ATTRIBUTE_NAME = "foo"
    ITEM_ATTRIBUTES = {
        'attribute': "default value",
    }
    ITEM_TYPE_NAME = "foo"
    REQUIRED_ATTRIBUTES = ['attribute']

    @classmethod
    def block_concurrent(cls, node_os, node_os_version):
        """
        Return a list of item types that cannot be applied in parallel
        with this item type.
        """
        return []

    def __repr__(self):
        return "&lt;Foo attribute:{}&gt;".format(self.attributes['attribute'])

    def cdict(self):
        """
        Return a statedict that describes the target state of this item
        as configured in the repo. An empty dict means that the item
        should not exist.

        Implementing this method is optional. The default implementation
        uses the attributes as defined in the bundle.
        """
        raise NotImplementedError

    def sdict(self):
        """
        Return a statedict that describes the actual state of this item
        on the node. An empty dict means that the item does not exist
        on the node.

        For the item to validate as correct, the values for all keys in
        self.cdict() have to match this statedict.
        """
        raise NotImplementedError

    def display_dicts(self, cdict, sdict, keys):
        """
        Given cdict and sdict as implemented above, modify them to
        better suit interactive presentation. The keys parameter is a
        list of keys whose values differ between cdict and sdict.

        Implementing this method is optional.
        """
        return (cdict, sdict, keys)

    def fix(self, status):
        """
        Do whatever is necessary to correct this item. The given ItemStatus
        object has the following useful information:

            status.keys     list of cdict keys that need fixing
            status.cdict    cached copy of self.cdict()
            status.sdict    cached copy of self.sdict()
        """
        raise NotImplementedError
</code></pre>
<p><br></p>
<h2 id="step-2-define-attributes">Step 2: Define attributes</h2>
<p><code>BUNDLE_ATTRIBUTE_NAME</code> is the name of the variable defined in a bundle module that holds the items of this type. If your bundle looks like this:</p>
<pre><code>foo = { [...] }
</code></pre>
<p>...then you should put <code>BUNDLE_ATTRIBUTE_NAME = "foo"</code> here.</p>
<p><code>ITEM_ATTRIBUTES</code> is a dictionary of the attributes users will be able to configure for your item. For files, that would be stuff like owner, group, and permissions. Every attribute (even if it's mandatory) needs a default value, <code>None</code> is totally acceptable:</p>
<pre><code>ITEM_ATTRIBUTES = {'attr1': "default1"}
</code></pre>
<p><code>ITEM_TYPE_NAME</code> sets the first part of an items ID. For the file items, this is "file". Therefore, file ID look this this: <code>file:/path</code>. The second part is the name a user assigns to your item in a bundle. Example:</p>
<pre><code>ITEM_TYPE_NAME = "foo"
</code></pre>
<p><code>REQUIRED_ATTRIBUTES</code> is a list of attribute names that must be set on each item of this type. If BundleWrap encounters an item without all these attributes during bundle inspection, an exception will be raised. Example:</p>
<pre><code>REQUIRED_ATTRIBUTES = ['attr1', 'attr2']
</code></pre>
<p><br></p>
<h2 id="step-3-implement-methods">Step 3: Implement methods</h2>
<p>You should probably start with <code>sdict()</code>. Use <code>self.node.run("command")</code> to run shell commands on the current node and check the <code>stdout</code> property of the returned object.</p>
<p>The only other method you have to implement is <code>fix</code>. It doesn't have to return anything and just uses <code>self.node.run()</code> to fix the item. To do this efficiently, it may use the provided parameters indicating which keys differ between the should-be sdict and the actual one. Both sdicts are also provided in case you need to know their values.</p>
<p><code>block_concurrent()</code> must return a list of item types (e.g. <code>['pkg_apt']</code>) that cannot be applied in parallel with this type of item. May include this very item type itself. For most items this is not an issue (e.g. creating multiple files at the same time), but some types of items have to be applied sequentially (e.g. package managers usually employ locks to ensure only one package is installed at a time).</p>
<p>If you're having trouble, try looking at the <a href="https://github.com/bundlewrap/bundlewrap/tree/master/bundlewrap/items">source code for the items that come with BundleWrap</a>. The <code>pkg_*</code> items are pretty simple and easy to understand while <code>files</code> is the most complex to date. Or just drop by on <a href="irc://chat.freenode.net/bundlewrap">IRC</a>, we're glad to help.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>BundleWrap is published under the <a href='https://github.com/bundlewrap/bundlewrap/blob/master/LICENSE'>GPL license</a>.</p><p> Donations welcome in Bitcoin <code>13AJYksqncZromPF8HvDUXsmHChAm3Y7W7</code> or Ethereum <code>0x5Eb3037e197d3C0d2E014bcfC2e027EB0AD42812</code>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
