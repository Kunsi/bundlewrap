<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Handling secrets - BundleWrap</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../bundlewrap.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-33891245-2', 'docs.bundlewrap.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">BundleWrap</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../.."><i class="fa fa-home"></i></a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../quickstart/">Quickstart</a>
</li>
                                    
<li >
    <a href="../installation/">Installation</a>
</li>
                                    
<li >
    <a href="../cli/">CLI</a>
</li>
                                    
<li >
    <a href="../env/">Environment Variables</a>
</li>
                                    
<li >
    <a href="../item_file_templates/">File templates</a>
</li>
                                    
<li class="active">
    <a href="./">Handling secrets</a>
</li>
                                    
<li >
    <a href="../locks/">Locking</a>
</li>
                                    
<li >
    <a href="../kubernetes/">Kubernetes</a>
</li>
                                    
<li >
    <a href="../dev_item/">Custom items</a>
</li>
                                    
<li >
    <a href="../dev_plugin/">Writing plugins</a>
</li>
                                    
<li >
    <a href="../api/">Python API</a>
</li>
                                    
<li >
    <a href="../os_compatibility/">OS compatibility</a>
</li>
                                    
<li >
    <a href="../migrate_12/">Migrating to 2.0</a>
</li>
                                    
<li >
    <a href="../migrate_23/">Migrating to 3.0</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Repository <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../repo/layout/">Overview</a>
</li>
                                    
<li >
    <a href="../../repo/nodes.py/">nodes.py</a>
</li>
                                    
<li >
    <a href="../../repo/groups.py/">groups.py</a>
</li>
                                    
<li >
    <a href="../../repo/requirements.txt/">requirements.txt</a>
</li>
                                    
<li >
    <a href="../../repo/items.py/">bundles/.../items.py</a>
</li>
                                    
<li >
    <a href="../../repo/metadata.py/">bundles/.../metadata.py</a>
</li>
                                    
<li >
    <a href="../../repo/hooks/">hooks/</a>
</li>
                                    
<li >
    <a href="../../repo/libs/">libs/</a>
</li>
                                    
<li >
    <a href="../../repo/plugins/">Plugins</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Items <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../items/action/">action</a>
</li>
                                    
<li >
    <a href="../../items/directory/">directory</a>
</li>
                                    
<li >
    <a href="../../items/file/">file</a>
</li>
                                    
<li >
    <a href="../../items/group/">group</a>
</li>
                                    
<li >
    <a href="../../items/k8s/">k8s_*</a>
</li>
                                    
<li >
    <a href="../../items/pkg_apt/">pkg_apt</a>
</li>
                                    
<li >
    <a href="../../items/pkg_dnf/">pkg_dnf</a>
</li>
                                    
<li >
    <a href="../../items/pkg_openbsd/">pkg_openbsd</a>
</li>
                                    
<li >
    <a href="../../items/pkg_opkg/">pkg_opkg</a>
</li>
                                    
<li >
    <a href="../../items/pkg_pacman/">pkg_pacman</a>
</li>
                                    
<li >
    <a href="../../items/pkg_pip/">pkg_pip</a>
</li>
                                    
<li >
    <a href="../../items/pkg_snap/">pkg_snap</a>
</li>
                                    
<li >
    <a href="../../items/pkg_yum/">pkg_yum</a>
</li>
                                    
<li >
    <a href="../../items/pkg_zypper/">pkg_zypper</a>
</li>
                                    
<li >
    <a href="../../items/postgres_db/">postgres_db</a>
</li>
                                    
<li >
    <a href="../../items/postgres_role/">postgres_role</a>
</li>
                                    
<li >
    <a href="../../items/svc_openbsd/">svc_openbsd</a>
</li>
                                    
<li >
    <a href="../../items/svc_systemd/">svc_systemd</a>
</li>
                                    
<li >
    <a href="../../items/svc_systemv/">svc_systemv</a>
</li>
                                    
<li >
    <a href="../../items/svc_upstart/">svc_upstart</a>
</li>
                                    
<li >
    <a href="../../items/symlink/">symlink</a>
</li>
                                    
<li >
    <a href="../../items/user/">user</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/about/">About</a>
</li>
                                    
<li >
    <a href="../../misc/deciding/">Why BundleWrap</a>
</li>
                                    
<li >
    <a href="../../misc/glossary/">Glossary</a>
</li>
                                    
<li >
    <a href="../../misc/faq/">FAQ</a>
</li>
                                    
<li >
    <a href="../../misc/contributing/">Contributing</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../item_file_templates/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../locks/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/bundlewrap/bundlewrap/edit/master/docs/guide/secrets.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#handling-secrets">Handling secrets</a></li>
            <li><a href="#secretscfg">.secrets.cfg</a></li>
            <li><a href="#derived-passwords">Derived passwords</a></li>
            <li><a href="#static-passwords">Static passwords</a></li>
            <li><a href="#files">Files</a></li>
            <li><a href="#key-management">Key management</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="handling-secrets">Handling secrets</h1>
<p>We strongly recommend <strong>not</strong> putting any sensitive information such as passwords or private keys into your repository. This page describes the helpers available in BundleWrap to manage those secrets without checking them into version control.</p>
<div class="alert alert-info">Most of the functions described here return lazy <a href="../api/#bundlewraputilsfault">Fault objects</a>.</div>

<p><br></p>
<h2 id="secretscfg">.secrets.cfg</h2>
<p>When you initially ran <code>bw repo create</code>, a file called <code>.secrets.cfg</code> was put into the root level of your repo. It's an INI-style file that by default contains two random keys BundleWrap uses to protect your secrets.</p>
<div class="alert alert-danger">You should never commit <code>.secrets.cfg</code>. Immediately add it to your <code>.gitignore</code> or equivalent.</div>

<p><br></p>
<h2 id="derived-passwords">Derived passwords</h2>
<p>In some cases, you can control (i.e. manage with BundleWrap) both ends of the authentication process. A common example is a config file for a web application that holds credentials for a database also managed by BundleWrap. In this case, you don't really care what the password is, you just want it to be the same on both sides.</p>
<p>To accomplish that, just write this in your template (Mako syntax shown here):</p>
<pre><code class="nohighlight">database_user = "foo"
database_password = "${repo.vault.password_for("my database")}"
</code></pre>

<p>In your bundle, you can then configure your database user like this:</p>
<pre><code>postgres_roles = {
    "foo": {
        'password': repo.vault.password_for("my database"),
    },
}
</code></pre>
<p>It doesn't really matter what string you call <code>password_for()</code> with, it just has to be the same on both ends. BundleWrap will then use that string, combine it with the default key called <code>generate</code> in your <code>.secrets.cfg</code> and derive a random password from that.</p>
<p>This makes it easy to change all your passwords at once (e.g. when an employee leaves or when required for compliance reasons) by rotating keys.</p>
<div class="alert alert-warning">However, it also means you have to guard your <code>.secrets.cfg</code> very closely. If it is compromised, so are <strong>all</strong> your passwords. Use your own judgement.</div>

<h3 id="human-passwords">"Human" passwords</h3>
<p>As an alternative to <code>password_for()</code>, which generates random strings, you can use <code>human_password_for()</code>.It generates strings like <code>Wiac-Kaobl-Teuh-Kumd-40</code>. They are easier to handle for human beings. You might want to use them if you have to type those passwords on a regular basis.</p>
<h3 id="random-bytes">Random bytes</h3>
<p><code>password_for()</code> and <code>human_password_for()</code> are meant for passwords. If you need plain random bytes, you can use <code>random_bytes_as_base64_for()</code>. As the name implies, it will return the data base64 encoded. Some examples:</p>
<pre><code class="nohighlight">$ bw debug -c 'print(repo.vault.random_bytes_as_base64_for("foo"))'
qczM0GUKW7YlXEuW8HGPYkjCGaX4Vu9Fja5SIZWga7w=
$ bw debug -c 'print(repo.vault.random_bytes_as_base64_for("foo", length=1))'
qQ==
</code></pre>

<p><br></p>
<h2 id="static-passwords">Static passwords</h2>
<p>When you need to store a specific password, you can encrypt it symmetrically:</p>
<pre><code class="nohighlight">$ bw debug -c "print(repo.vault.encrypt('my password'))"
gAAAA[...]mrVMA==
</code></pre>

<p>You can then use this encrypted password in a template like this:</p>
<pre><code class="nohighlight">database_user = "foo"
database_password = "${repo.vault.decrypt("gAAAA[...]mrVMA==")}"
</code></pre>

<p><br></p>
<h2 id="files">Files</h2>
<p>You can also encrypt entire files:</p>
<pre><code class="nohighlight">$ bw debug -c "repo.vault.encrypt_file('/my/secret.file', 'encrypted.file')"</code></pre>

<div class="alert alert-info">Encrypted files are always read and written relative to the <code>data/</code> subdirectory of your repo.</div>

<p>If the source file was encoded using UTF-8, you can then simply pass the decrypted content into a file item:</p>
<pre><code>files = {
    "/secret": {
        'content': repo.vault.decrypt_file("encrypted.file"),
    },
}
</code></pre>
<p>If the source file is binary however (or any encoding other than UTF-8), you must use base64:</p>
<pre><code>files = {
    "/secret": {
        'content': repo.vault.decrypt_file_as_base64("encrypted.file"),
        'content_type': 'base64',
    },
}
</code></pre>
<p><br></p>
<h2 id="key-management">Key management</h2>
<h3 id="multiple-keys">Multiple keys</h3>
<p>You can always add more keys to your <code>.secrets.cfg</code>, but you should keep the defaults around. Adding more keys makes it possible to give different keys to different teams. <strong>By default, BundleWrap will skip items it can't find the required keys for</strong>.</p>
<p>When using <code>.password_for()</code>, <code>.decrypt()</code> etc., you can provide a <code>key</code> argument to select the key:</p>
<pre><code>repo.vault.password_for("some database", key="devops")
</code></pre>
<p><br></p>
<h3 id="rotating-keys">Rotating keys</h3>
<div class="alert alert-info">This is applicable mostly to <code>.password_for()</code>. The other methods use symmetric encryption and require manually updating the encrypted text after the key has changed.</div>

<p>You can generate a new key by running <code>bw debug -c "print(repo.vault.random_key())"</code>. Place the result in your <code>.secrets.cfg</code>. Then you need to distribute the new key to your team and run <code>bw apply</code> for all your nodes.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>BundleWrap is published under the <a href='https://github.com/bundlewrap/bundlewrap/blob/master/LICENSE'>GPL license</a>.</p><p> Donations welcome in Bitcoin <code>13AJYksqncZromPF8HvDUXsmHChAm3Y7W7</code> or Ethereum <code>0x5Eb3037e197d3C0d2E014bcfC2e027EB0AD42812</code>.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
